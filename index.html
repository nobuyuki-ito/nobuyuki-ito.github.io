<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/beige.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-markdown data-separator-notes="^Note:">
					<textarea data-template>
# Suricata + ELK Stackで作るオフラインpcap分析環境
by [@nobuyuki_ito](https://twitter.com/nobuyuki_ito)

---

# 自己紹介
* 名前：[Nobuyuki Ito](https://twitter.com/nobuyuki_ito)
* インフラエンジニア/セキュリティアナリスト見習いN年目

---

# 1. はじめに
# 2. 環境準備
# 3. 分析
# 4. 終わりに

---

# 1. はじめに
## 情報ソース
## 分析ツール
## 課題

---

## 情報ソース

* pcapファイル
* フラットファイル

  * Webサーバ/sshdのアクセスログ
  * 各種OSログ
  * CSVファイル

---

## 分析ツール
* grep, sed, awk
* perl, python, ruby
* Excel
* tcpdump, Wireshark
* Kibana

---

## 課題

* 幾千億のログフォーマット
* 職人芸的
* pcap, フラットファイルの横断的な分析
* 可視化

---

### Apache HTTP Server

* アクセスログを集計してみる
* 送信元IPアドレス、メソッド、レスポンスコード毎の件数

```
Aug 05 10:02:12 testweb.2ito.com httpd[704]: 192.0.2.210 - - 
[05/Aug/2017:10:02:12 +0900] "GET /index.html HTTP/1.1" 404
241 "-" "curl/7.53.1"
```

---

### perlでやってみる

```
journalctl -al --unit=httpd --since yesterday | \
perl -F'\s+' -lnae '
$F[10] =~ s/^.//;
$F[5] =~ /^(\d{1,3}\.){3}\d{1,3}$/ and 
$access{$F[5]}->{$F[10]}->{$F[13]}++;
}
foreach my $src ( keys %access ) {
 foreach my $method ( sort keys %{$access{$src}} ) {
  foreach ( sort keys %{$access{$src}->{$method}} ) {
   print "$src\t$method\t$_\t$access{$src}->{$method}->{$_}";
  }
 }
}
{'|more
```

```
192.0.2.210    GET     200     71
192.0.2.10     GET     404     1
```

---

### 確かに出来る
* スクリプトの集計は楽しい！

  * シェル芸
  * ワンライナー

* プログラミングの勉強にもなる（こともある）

---

### みんな大好きExcel

* CSV/TSVへの変換が必要
* ピボットテーブル + グラフ
* 大量のデータには対応できない

---

# 集計は本質ではない

---

# その先の分析に時間を使おう！

---

# 2. 環境準備
## OS
## Suricata
## ELK Stack

---

## OS

* お好みのLinuxディストリビューションをインストールしておく
* 今回はFedora 28を利用します
* CentOS 7.x, Ubuntu他好きなようにどうぞ
* Xは不要

---

### まさかインストーラを一つずつ進めてインストールしようとしてないよね？

---

### Fedora/CentOS インストールtips

* kickstartインストールにPXE bootは必須ではない
* 仮想マシンであればISOイメージをboot
* CDROMからのブート時でも引数に一手間加えるだけで使える
* Installation Guide の [Boot Options](https://docs.fedoraproject.org/f28/install-guide/advanced/Boot_Options.html) をありがたく拝見

---

```
inst.repo=cdrom \
ip=192.0.2.210::192.0.2.254:255.255.255.0:example:eth0:none \
inst.ks=http://www.example.com/test-ks.cfg
```

* inst.repo: cdromをインストール媒体に指定
* ip: IPアドレスを直接指定する
* inst.ks: Kickstart 設定ファイルを読み込む
* 適当なサーバにApache or nginxを突っ込んでおく
* [GitHub](https://qiita.com/budougumi0617/items/221bb946d1c90d6769e9) にだって置けるし、 [Amazon S3](https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html) に置いたっていい

---

## Suricata

* version 4.0.0 以上をインストール
* 2018年5月14日(月)時点の最新版は [4.0.4](https://suricata-ids.org/download/)
* Centos 7.x では[epel](https://fedoraproject.org/wiki/EPEL)の追加が必要

```
dnf install suricata
```

---

### Snort rule ダウンロード

* ダウンロードには [ユーザ登録](https://www.snort.org/users/sign_up) が必要

  * Emailだけでよい

* [ダウンロードページ](https://www.snort.org/downloads)

  * Community rules: [community-rules.tar.gz](https://www.snort.org/downloads/community/community-rules.tar.gz)
  * Registered rules: [snortrules-snapshot-29111.tar.gz](https://www.snort.org/downloads/registered/snortrules-snapshot-29111.tar.gz)

---

### EmergingThreats rule ダウンロード

* ユーザ登録不要
* [OPEN Download Instructions](https://rules.emergingthreats.net/OPEN_download_instructions.html)

  * Suricata 4.0向けルールを利用
  * [emerging.rules.tar.gz](https://rules.emergingthreats.net/open-nogpl/suricata-4.0/emerging.rules.tar.gz)



### Suricata 初期設定

* /etc/suricata/suricata.yaml を修正

  * suricata/suricata.yaml.patch を当てる

* ルールのインストール

  * suricata/applyRules.sh を実行

---

## ELK Stack

* [Logstash](https://www.elastic.co/downloads/logstash)
* [Elasticsearch](https://www.elastic.co/downloads/elasticsearch)
* [Kibana](https://www.elastic.co/downloads/kibana)
* 2018年5月14日(月)時点の最新版は6.2.4
* Internetにつながる環境であれば [レポジトリを追加](https://www.elastic.co/guide/en/elasticsearch/reference/current/rpm.html) した方が速い

```
dnf install java-1.8.0-openjdk-headless logstash \
elasticsearch kibana
```

---

# 3. 分析

---

# 4. 終わりに

---

ご清聴ありがとうございました

					</textarea>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
